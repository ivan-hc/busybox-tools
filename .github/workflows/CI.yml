name: Busybox binaries download
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: "0 12 7/7 * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: build
      if: always()
      run: |
        architectures="i686 x86_64"
        ref="https://busybox.net"

        for arch in $architectures; do
           subdir=$(curl -Ls https://busybox.net/downloads/binaries/ | tr '">< ' '\n' | grep "^[0-9].*$arch.*/$" | tail -1 | sed 's#/$##g')
           source_list=$(curl -Ls https://busybox.net/downloads/binaries/"$subdir")
           wget -r -l1 --no-parent https://busybox.net/downloads/binaries/"$subdir"
           mkdir -p dist-"$arch"
           cp -r busybox.net/downloads/binaries/"$subdir"/* dist-"$arch"/
           for f in dist-"$arch"/busybox_* ; do 
              mv "$f" "$f-$arch"
           done
        done
        mkdir -p dist
        mv dist-*/* dist/

    - name: Upload artifact
      uses: actions/upload-artifact@v4.4.0
      with:
        name: busybox-binaries
        path: 'dist'
       
  release:
      needs: [build]
      permissions: write-all
      runs-on: ubuntu-latest

      steps:
        - uses: actions/download-artifact@v4.1.8
          with:
            name: busybox-binaries

        - name: busybox-tools-x86_64
          uses: marvinpinto/action-automatic-releases@latest
          with:
            title: busybox-tools-x86_64
            automatic_release_tag: busybox-tools-x86_64
            prerelease: true
            draft: false
            files: |
              busybox_*-x86_64
            repo_token: ${{ secrets.GITHUB_TOKEN }}

        - name: busybox-tools-i686
          uses: marvinpinto/action-automatic-releases@latest
          with:
            title: busybox-tools-i686
            automatic_release_tag: busybox-tools-i686
            prerelease: true
            draft: false
            files: |
              busybox_*-i686
            repo_token: ${{ secrets.GITHUB_TOKEN }}
